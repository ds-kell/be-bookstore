Pass V002221:Kell0502
Trigger 1

USE [bs_db]
GO
/****** Object:  Trigger [dbo].[trigger_update_book_detail]    Script Date: 11/8/2023 5:38:23 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER TRIGGER [dbo].[trigger_update_book_detail]
ON [bs_db].[dbo].[tbl_picking_in_detail]
AFTER INSERT
AS
BEGIN
    DECLARE @id_book INT
    DECLARE @quantity INT

    SELECT @id_book = id_book, @quantity = quantity FROM inserted

    UPDATE [bs_db].[dbo].[tbl_book_detail]
    SET quantity = quantity + @quantity
    WHERE id_book = @id_book
END

Trigger 2

USE [bs_db]
GO
/****** Object:  Trigger [dbo].[trigger_update_book_detail_picking_out]    Script Date: 11/8/2023 5:38:34 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER TRIGGER [dbo].[trigger_update_book_detail_picking_out]
ON [bs_db].[dbo].[tbl_picking_out_detail]
AFTER INSERT
AS
BEGIN
		DECLARE @id_book INT
		DECLARE @quantity INT

		SELECT @id_book = id_book, @quantity = quantity FROM inserted

		BEGIN TRANSACTION;

    IF EXISTS (SELECT 1 FROM [bs_db].[dbo].[tbl_book_detail] WHERE id_book = @id_book AND quantity >= @quantity)
		BEGIN
			UPDATE [bs_db].[dbo].[tbl_book_detail]
			SET quantity = quantity - @quantity
			WHERE id_book = @id_book;
		END
    ELSE
		BEGIN
			PRINT N'Invalid data'
			ROLLBACK TRANSACTION;
		END
		COMMIT TRANSACTION;
END

Trigger 3

USE [bs_db]
GO
/****** Object:  Trigger [dbo].[trg_CheckAndUpdateBookDetail]    Script Date: 11/8/2023 5:34:35 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER TRIGGER [dbo].[trg_CheckAndUpdateBookDetail]
ON [bs_db].[dbo].[tbl_book_detail]
FOR INSERT
AS
BEGIN
    DECLARE @id_book INT, @id_branch INT

    SELECT @id_book = i.id_book, @id_branch = i.id_branch
    FROM Inserted i

    IF EXISTS (SELECT 1 FROM [bs_db].[dbo].[tbl_book_detail] bd
               WHERE bd.id_book = @id_book AND bd.id_branch = @id_branch)
    BEGIN
        UPDATE bd
        SET bd.quantity = bd.quantity + i.quantity
        FROM Inserted i
        INNER JOIN [bs_db].[dbo].[tbl_book_detail] bd ON bd.id_book = i.id_book AND bd.id_branch = i.id_branch
    END
    ELSE
    BEGIN
        INSERT INTO [bs_db].[dbo].[tbl_book_detail] (id, quantity, id_book, id_branch)
        SELECT id, quantity, id_book, id_branch
        FROM Inserted
    END
END;

//TRIGGER 4

USE [bs_db_2]
GO

ALTER TRIGGER [dbo].[trigger_update_book_detail_picking_out]
ON [bs_db_2].[dbo].[tbl_picking_out_detail]
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        DECLARE @id_book INT;
        DECLARE @quantity INT;

        DECLARE update_cursor CURSOR LOCAL FORWARD_ONLY FOR
        SELECT id_book, quantity FROM inserted;

        OPEN update_cursor;

        FETCH NEXT FROM update_cursor INTO @id_book, @quantity;

        WHILE @@FETCH_STATUS = 0
        BEGIN
            BEGIN TRANSACTION;

            IF EXISTS (SELECT 1 FROM [bs_db_2].[dbo].[tbl_book_detail] WHERE id_book = @id_book AND quantity >= @quantity)
            BEGIN
                UPDATE [bs_db_2].[dbo].[tbl_book_detail]
                SET quantity = quantity - @quantity
                WHERE id_book = @id_book;
            END
            ELSE
            BEGIN
                ROLLBACK TRANSACTION;
            END

            COMMIT TRANSACTION;

            FETCH NEXT FROM update_cursor INTO @id_book, @quantity;
        END

        CLOSE update_cursor;
        DEALLOCATE update_cursor;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
    END CATCH
END
